<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Log Kegiatan Kerja</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #333; }
    .container { width: 900px; margin: 20px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    input, button { width: 100%; padding: 20px; margin: 5px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 20px; }
    button { cursor: pointer; font-weight: bold; border: none; transition: 0.3s; }
    .start { background: #4caf50; color:white; }
    .break { background: #ff9800; color:white; }
    .resume { background: #2196f3; color:white; }
    .finish { background: #f44336; color:white; }
    .delete { background: #555; color:white; }
    .export { background: #009688; color:white; }
    .delete-row, .edit-row { padding: 4px 8px; border-radius: 6px; border: none; cursor: pointer; color: white; }
    .delete-row { background: #d32f2f; }
    .edit-row { background: #1976d2; margin-right: 4px; }
    table { width: 100%; margin-top: 10px; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #eee; }
    #summary { background: #e8f5e9; padding: 10px; border-radius: 8px; margin-top: 15px; text-align: center; font-weight: bold; color: #2e7d32; }
    #aktif { background: #e3f2fd; color: #0d47a1; border: 1px solid #90caf9; padding: 10px; border-radius: 8px; margin-top: 10px; display: none; text-align: center; font-weight: bold; }
    .filter-container { display: flex; gap: 10px; align-items: center; margin-top: 15px; margin-bottom: 10px; }
    .filter-container input[type="date"], .filter-container button { padding: 10px; font-size: 16px; }
    .filter-container input[type="date"] { flex: 1; }
  </style>
</head>
<body>
  <h1>Log Kegiatan Kerja</h1>

  <!-- Auth Section -->
  <div id="authContainer" class="container">
    <h2>Daftar / Login</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button onclick="registerUser()">Daftar</button>
    <button onclick="loginUser()">Login</button>
    <div id="authMsg" style="color:red; margin-top:10px;"></div>
  </div>

  <!-- Main Section -->
  <div id="mainContainer" class="container" style="display:none;">
    <div>Selamat datang, <span id="welcomeUser"></span> <button onclick="logoutUser()">Logout</button></div>
    <label for="kegiatan">Kegiatan:</label>
    <input type="text" id="kegiatan" placeholder="Tulis kegiatan kamu...">
    <button class="start" onclick="mulaiKegiatan()">‚ñ∂Ô∏è Start</button>
    <button class="break" onclick="istirahat()">‚òï Istirahat</button>
    <button class="resume" onclick="selesaiIstirahat()">üîµ Selesai Istirahat</button>
    <button class="finish" onclick="selesai()">‚úÖ Selesai</button>
    <button class="delete" onclick="hapusSemua()">üóëÔ∏è Hapus Semua Data</button>
    <button class="export" onclick="eksporCSV()">üì§ Ekspor ke CSV</button>

    <div id="aktif"></div>
    <div id="summary"></div>

    <div class="filter-container">
      <input type="date" id="filterTanggal">
      <button onclick="filterTanggal()">üîç Tampilkan</button>
      <button onclick="tampilkanSemua()">üìã Tampilkan Semua</button>
    </div>

    <table id="logTable">
      <thead>
        <tr>
          <th>No.</th>
          <th>Tanggal</th>
          <th>Kegiatan</th>
          <th>Mulai</th>
          <th>Selesai</th>
          <th>Durasi</th>
          <th>Status</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>

  <script>
    // ====== Firebase Config (ganti dengan milikmu) ======
    const firebaseConfig = {
      apiKey: "AIzaSyAUKZF-5BsyyzPWJgWvS6rw0-vredthTvI",
      authDomain: "log-kegiatan.firebaseapp.com",
      projectId: "log-kegiatan",
      storageBucket: "log-kegiatan.firebasestorage.app",
      messagingSenderId: "395363028551",
      appId: "1:395363028551:web:f4e9ff9fc6651f843c2b62"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ====== Auth Functions ======
    function registerUser(){
      const email=document.getElementById("email").value;
      const password=document.getElementById("password").value;
      auth.createUserWithEmailAndPassword(email,password)
        .then(userCredential=>{
          document.getElementById("authMsg").textContent="Daftar berhasil. Silakan login.";
        })
        .catch(err=>document.getElementById("authMsg").textContent=err.message);
    }

    function loginUser(){
      const email=document.getElementById("email").value;
      const password=document.getElementById("password").value;
      auth.signInWithEmailAndPassword(email,password)
        .then(userCredential=>{
          document.getElementById("authContainer").style.display="none";
          document.getElementById("mainContainer").style.display="block";
          document.getElementById("welcomeUser").textContent=userCredential.user.email;
          document.getElementById("filterTanggal").value=formatTanggalISO(new Date());
          tampilkanDataTerfilter();
        })
        .catch(err=>document.getElementById("authMsg").textContent=err.message);
    }

    function logoutUser(){ auth.signOut().then(()=>{ location.reload(); }); }

    // ====== Waktu & Kegiatan ======
    let kegiatanAktif=null, waktuMulai=null, status="Belum mulai", waktuIstirahatMulai=null, totalDurasiIstirahat=0, timerInterval=null;

    function formatWaktu(date){ return `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}:${String(date.getSeconds()).padStart(2,'0')}`; }
    function formatTanggalISO(date){ return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`; }
    function formatTanggalLokal(date){ return date.toLocaleDateString('id-ID', {year:'numeric', month:'long', day:'numeric'}); }

    function tampilkanAktif(){
      const div = document.getElementById("aktif");
      if(kegiatanAktif){ div.style.display="block"; updateTimer(); clearInterval(timerInterval); timerInterval=setInterval(updateTimer,1000); }
      else { div.style.display="none"; clearInterval(timerInterval); }
    }

    function updateTimer(){
      const now=new Date();
      const durasiMs = now - waktuMulai - totalDurasiIstirahat;
      const detikTotal=Math.floor(durasiMs/1000);
      const jam=Math.floor(detikTotal/3600), menit=Math.floor((detikTotal%3600)/60), detik=detikTotal%60;
      document.getElementById("aktif").textContent=`üîµ Kegiatan: ${kegiatanAktif} | Durasi: ${jam}j ${menit}m ${detik}s`;
    }

    function mulaiKegiatan(){
      const kegiatan=document.getElementById("kegiatan").value.trim();
      if(!kegiatan) return alert("Isi nama kegiatan.");
      if(kegiatanAktif) return alert("Selesaikan dulu kegiatan aktif.");
      waktuMulai=new Date(); kegiatanAktif=kegiatan; totalDurasiIstirahat=0; status="Berjalan"; tampilkanAktif();
    }
    function istirahat(){ if(!kegiatanAktif||status!=="Berjalan") return alert("Belum ada kegiatan berjalan."); waktuIstirahatMulai=new Date(); status="Istirahat"; clearInterval(timerInterval); document.getElementById("aktif").textContent=`‚òï Istirahat dari ${kegiatanAktif}`; }
    function selesaiIstirahat(){ if(status!=="Istirahat") return alert("Belum istirahat."); totalDurasiIstirahat+=new Date()-waktuIstirahatMulai; waktuIstirahatMulai=null; status="Berjalan"; tampilkanAktif(); }

    function selesai(){
      if(!kegiatanAktif||!waktuMulai) return alert("Belum ada kegiatan dimulai.");
      const selesaiWaktu=new Date();
      const durasiMs = selesaiWaktu - waktuMulai - totalDurasiIstirahat;
      const detikTotal=Math.floor(durasiMs/1000);
      const jam=Math.floor(detikTotal/3600), menit=Math.floor((detikTotal%3600)/60), detik=detikTotal%60;

      const data={
        userId: auth.currentUser.uid,
        tanggalISO: formatTanggalISO(waktuMulai),
        tanggalLokal: formatTanggalLokal(waktuMulai),
        kegiatan: kegiatanAktif,
        mulai: formatWaktu(waktuMulai),
        selesai: formatWaktu(selesaiWaktu),
        durasiDetik: detikTotal,
        durasi: `${jam}j ${menit}m ${detik}s`,
        status: "Selesai",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      db.collection("logKegiatan").add(data).then(()=>{
        kegiatanAktif=null; waktuMulai=null; status="Belum mulai"; tampilkanAktif();
        document.getElementById("kegiatan").value="";
        tampilkanDataTerfilter();
      });
    }

    // ====== Tabel ======
    function tambahKeTabel(data, nomor){
      const tabel=document.querySelector("#logTable tbody");
      const row=tabel.insertRow(); row.dataset.id=data.id;
      row.insertCell(0).textContent=nomor;
      row.insertCell(1).textContent=data.tanggalLokal;
      row.insertCell(2).textContent=data.kegiatan;
      row.insertCell(3).textContent=data.mulai;
      row.insertCell(4).textContent=data.selesai;
      row.insertCell(5).textContent=data.durasi;
      row.insertCell(6).textContent=data.status;
      const aksiCell=row.insertCell(7);
      const editBtn=document.createElement("button"); editBtn.textContent="‚úèÔ∏è"; editBtn.classList.add("edit-row");
      editBtn.onclick=()=>{ editKegiatan(data.id,data.kegiatan); };
      const deleteBtn=document.createElement("button"); deleteBtn.textContent="‚ùå"; deleteBtn.classList.add("delete-row");
      deleteBtn.onclick=()=>{ hapusSatu(data.id); };
      aksiCell.appendChild(editBtn); aksiCell.appendChild(deleteBtn);
    }

    function editKegiatan(docId, oldKegiatan){
      const newKegiatan=prompt("Edit nama kegiatan:", oldKegiatan);
      if(newKegiatan && newKegiatan.trim()!==""){
        db.collection("logKegiatan").doc(docId).update({kegiatan:newKegiatan.trim()})
        .then(()=>tampilkanDataTerfilter());
      }
    }

    function hapusSatu(docId){ if(confirm("Yakin hapus?")){ db.collection("logKegiatan").doc(docId).delete().then(()=>tampilkanDataTerfilter()); } }
    function hapusSemua(){ if(confirm("Yakin hapus semua?")){ db.collection("logKegiatan").where("userId","==",auth.currentUser.uid).get().then(snap=>{ const batch=db.batch(); snap.forEach(d=>batch.delete(d.ref)); batch.commit().then(()=>tampilkanDataTerfilter()); }); } }

    function tampilkanDataTerfilter(){
      const tanggal=document.getElementById("filterTanggal").value||formatTanggalISO(new Date());
      db.collection("logKegiatan").where("userId","==",auth.currentUser.uid)
        .where("tanggalISO","==",tanggal)
        .orderBy("createdAt")
        .get()
        .then(snapshot=>{
          const tabel=document.querySelector("#logTable tbody"); tabel.innerHTML="";
          let i=1;
          snapshot.forEach(doc=>{ const data=doc.data(); data.id=doc.id; tambahKeTabel(data,i++); });
          perbaruiTotalTanggal(tanggal);
        });
    }

    function tampilkanSemua(){
      db.collection("logKegiatan").where("userId","==",auth.currentUser.uid).orderBy("createdAt")
        .get().then(snapshot=>{
          const tabel=document.querySelector("#logTable tbody"); tabel.innerHTML="";
          let i=1;
          snapshot.forEach(doc=>{ const data=doc.data(); data.id=doc.id; tambahKeTabel(data,i++); });
          perbaruiTotalTanggal();
        });
    }

    function perbaruiTotalTanggal(tanggal=null){
      let q=db.collection("logKegiatan").where("userId","==",auth.currentUser.uid);
      if(tanggal) q=q.where("tanggalISO","==",tanggal);
      q.get().then(snapshot=>{
        let totalDetik=0; snapshot.forEach(doc=>{ totalDetik+=doc.data().durasiDetik||0; });
        const jam=Math.floor(totalDetik/3600), menit=Math.floor((totalDetik%3600)/60), detik=totalDetik%60;
        const tglObj=tanggal?new Date(tanggal):new Date();
        document.getElementById("summary").textContent=`üóìÔ∏è ${formatTanggalLokal(tglObj)} | ‚è∞ Total Waktu Kerja: ${jam}j ${menit}m ${detik}s`;
      });
    }

    function filterTanggal(){ tampilkanDataTerfilter(); }

    function eksporCSV(){
      let tanggal=document.getElementById("filterTanggal").value;
      let q=db.collection("logKegiatan").where("userId","==",auth.currentUser.uid);
      if(tanggal) q=q.where("tanggalISO","==",tanggal);
      q.orderBy("createdAt").get().then(snapshot=>{
        if(snapshot.empty) return alert("Tidak ada data untuk tanggal ini.");
        const header=["No.","Tanggal","Kegiatan","Mulai","Selesai","Durasi","Status"];
        const rows=[]; let i=1;
        snapshot.forEach(doc=>{ const d=doc.data(); rows.push([i++,d.tanggalLokal,d.kegiatan,d.mulai,d.selesai,d.durasi,d.status]); });
        const csv=[header,...rows].map(e=>e.join(",")).join("\n");
        const link=document.createElement("a"); link.href="data:text/csv;charset=utf-8,"+encodeURIComponent(csv);
        link.download=tanggal?`log_kegiatan_${tanggal}.csv`:"log_kegiatan_semua.csv"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
      });
    }

    window.onload=()=>{ document.getElementById("filterTanggal").value=formatTanggalISO(new Date()); };
  </script>
</body>
</html>
